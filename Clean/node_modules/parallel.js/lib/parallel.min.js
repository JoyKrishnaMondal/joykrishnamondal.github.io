(function(){function r(e,t){t||(t={});for(var n in e)t[n]===undefined&&(t[n]=e[n]);return t}function i(){this._callbacks=[],this._errCallbacks=[],this._resolved=0,this._result=null}function o(e,t){this.data=e,this.options=r(s,t),this.operation=new i,this.operation.resolve(null,this.data),this.requiredScripts=[],this.requiredFunctions=[]}var e=typeof module!="undefined"&&module.exports,t=t||function(e){setTimeout(e,0)},n=e?require(__dirname+"/Worker.js"):self.Worker;i.prototype.resolve=function(e,t){if(!e){this._resolved=1,this._result=t;for(var n=0;n<this._callbacks.length;++n)this._callbacks[n](t)}else{this._resolved=2,this._result=e;for(var r=0;r<this._errCallbacks.length;++r)this._errCallbacks[r](t)}this._callbacks=[],this._errCallbacks=[]},i.prototype.then=function(e,t){if(this._resolved===1){e&&e(this._result);return}if(this._resolved===2){t&&t(this._result);return}return e&&(this._callbacks[this._callbacks.length]=e),t&&(this._errCallbacks[this._errCallbacks.length]=t),this};var s={evalPath:e?__dirname+"/eval.js":null,maxWorkers:e?require("os").cpus().length:4,synchronous:!0};o.prototype.getWorkerSource=function(t){var n="",r=0;!e&&this.requiredScripts.length!==0&&(n+='importScripts("'+this.requiredScripts.join('","')+'");\r\n');for(r=0;r<this.requiredFunctions.length;++r)this.requiredFunctions[r].name?n+="var "+this.requiredFunctions[r].name+" = "+this.requiredFunctions[r].fn.toString()+";":n+=this.requiredFunctions[r].fn.toString();return e?n+'process.on("message", function(e) {process.send(JSON.stringify(('+t.toString()+")(JSON.parse(e).data)))})":n+"self.onmessage = function(e) {self.postMessage(("+t.toString()+")(e.data))}"},o.prototype.require=function(){var e=Array.prototype.slice.call(arguments,0),t;for(var n=0;n<e.length;n++)t=e[n],typeof t=="string"?this.requiredScripts.push(t):typeof t=="function"?this.requiredFunctions.push({fn:t}):typeof t=="object"&&this.requiredFunctions.push(t)},o.prototype._spawnWorker=function(t){var r,i=this.getWorkerSource(t);if(e)r=new n(this.options.evalPath),r.postMessage(i);else{if(n===undefined)return undefined;try{if(this.requiredScripts.length!==0){if(this.options.evalPath===null)throw new Error("Can't use required scripts without eval.js!");r=new n(this.options.evalPath),r.postMessage(i)}else{var s=new Blob([i],{type:"text/javascript"}),o=URL.createObjectURL(s);r=new n(o)}}catch(u){if(this.options.evalPath===null)throw u;r=new n(this.options.evalPath),r.postMessage(i)}}return r},o.prototype.spawn=function(e){var n=this,r=new i;return this.operation.then(function(){var i=n._spawnWorker(e);if(i!==undefined)i.onmessage=function(e){i.terminate(),n.data=e.data,r.resolve(null,n.data)},i.postMessage(n.data);else{if(!n.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");t(function(){n.data=e(n.data),r.resolve(null,n.data)})}}),this.operation=r,this},o.prototype._spawnMapWorker=function(e,n,r){var i=this,s=i._spawnWorker(n);if(s!==undefined)s.onmessage=function(t){s.terminate(),i.data[e]=t.data,r()},s.postMessage(i.data[e]);else{if(!i.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");t(function(){i.data[e]=n(i.data[e]),r()})}},o.prototype.map=function(e){function s(){++r===t.data.length?o.resolve(null,t.data):n<t.data.length&&t._spawnMapWorker(n++,e,s)}if(!this.data.length)return this.spawn(e);var t=this,n=0,r=0,o=new i;return this.operation.then(function(){for(;n-r<t.options.maxWorkers&&n<t.data.length;++n)t._spawnMapWorker(n,e,s)}),this.operation=o,this},o.prototype._spawnReduceWorker=function(e,n,r){var i=this,s=i._spawnWorker(n);if(s!==undefined)s.onmessage=function(e){s.terminate(),i.data[i.data.length]=e.data,r()},s.postMessage(e);else{if(!i.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");t(function(){i.data[i.data.length]=n(e),r()})}},o.prototype.reduce=function(e){function r(i){--t,n.data.length===1&&t===0?(n.data=n.data[0],s.resolve(null,n.data)):n.data.length>1&&(++t,n._spawnReduceWorker([n.data[0],n.data[1]],e,r),n.data.splice(0,2))}if(!this.data.length)throw new Error("Can't reduce non-array data");var t=0,n=this,s=new i;return this.operation.then(function(){if(n.data.length===1)s.resolve(null,n.data[0]);else{for(var i=0;i<n.options.maxWorkers&&i<Math.floor(n.data.length/2);++i)++t,n._spawnReduceWorker([n.data[i*2],n.data[i*2+1]],e,r);n.data.splice(0,i*2)}}),this.operation=s,this},o.prototype.then=function(e,t){var n=this,r=new i;return this.operation.then(function(){var t=e(n.data);t!==undefined&&(n.data=t),r.resolve(null,n.data)},t),this.operation=r,this},e?module.exports=o:self.Parallel=o})();